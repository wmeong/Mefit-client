<template>
    <v-dialog v-model="visible" max-width="750px" @click:outside="closeDialog">
        <v-card :class="[personalColorGroup, 'popup-card']">
            <v-card>
                <v-card-title class="close-button">
                    <v-col cols="12" class="text-center">
                        <h3 class="center-title">üåü Character Info üåü</h3>
                    </v-col>
                    <v-spacer></v-spacer>
                    <v-btn icon @click="closeDialog">
                        <v-icon>mdi-close</v-icon>
                    </v-btn>
                </v-card-title>

                <v-card-text>
                    <v-container class="character-popup">
                        <v-row>
                            <!-- Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ ÏôºÏ™Ω Î∞∞Ïπò (Ï§ëÏïô Ï†ïÎ†¨ Ïú†ÏßÄ) -->
                            <v-col
                                cols="4"
                                class="text-center d-flex justify-center align-center"
                            >
                                <img
                                    v-if="characterInfo.image"
                                    :src="characterInfo.image"
                                    alt="Character"
                                    class="character-img"
                                />
                            </v-col>
                            <v-col cols="2" class="text-center"> </v-col>

                            <!-- ÌçºÏä§ÎÑêÏª¨Îü¨, Î©îÏù∏Ïª¨Îü¨, ÏÑúÎ∏åÏª¨Îü¨ Ïò§Î•∏Ï™Ω Î∞∞Ïπò -->
                            <v-col
                                cols="5"
                                class="color-container d-flex flex-column justify-center"
                            >
                                <!-- ÌçºÏä§ÎÑêÏª¨Îü¨ ÌëúÏãú -->
                                <div
                                    :class="[
                                        'personal-color-result',
                                        personalColorGroup,
                                    ]"
                                    class=""
                                >
                                    {{ characterInfo.personalColor }}
                                </div>

                                <!-- Ïª¨Îü¨ Î∞ïÏä§ (Î©îÏù∏, ÏÑúÎ∏åÏª¨Îü¨ ÌÜµÌï©) -->
                                <v-row
                                    :class="['color-box', personalColorGroup]"
                                    class="align-items-center justify-center"
                                >
                                    <v-col cols="12" class="text-center">
                                        <h4 class="color-label">Î©îÏù∏Ïª¨Îü¨</h4>
                                        <div class="d-flex justify-center">
                                            <v-avatar
                                                v-for="(
                                                    color, index
                                                ) in characterInfo.mainColors"
                                                :key="'main-color-' + index"
                                                :color="color"
                                                size="33"
                                                class="mr-2"
                                            ></v-avatar>
                                        </div>
                                    </v-col>
                                    <v-col cols="12" class="text-center">
                                        <h4 class="color-label">ÏÑúÎ∏åÏª¨Îü¨</h4>
                                        <div class="d-flex justify-center">
                                            <v-avatar
                                                v-for="(
                                                    color, index
                                                ) in characterInfo.subColors"
                                                :key="'sub-color-' + index"
                                                :color="color"
                                                size="33"
                                                class="mr-2"
                                            ></v-avatar>
                                        </div>
                                    </v-col>
                                </v-row>
                            </v-col>
                        </v-row>

                        <v-row dense>
                            <v-col
                                v-for="(item, index) in characterInfo.items"
                                :key="index"
                                cols="4"
                            >
                                <v-card class="item-card">
                                    <v-card-text class="item-content">
                                        <!-- ‚úÖ ÏïÑÏù¥ÌÖú ÏïÑÏù¥ÏΩò -->
                                        <img
                                            v-if="item.item_icon"
                                            :src="item.item_icon"
                                            alt="Item Icon"
                                            class="item-icon"
                                        />
                                        <div class="item-info">
                                            <div class="item-name">
                                                {{ item.item_name }}
                                            </div>
                                            <div class="item-type">
                                                {{ item.item_type }}
                                            </div>

                                            <!-- ‚úÖ ÏÉâÏÉÅ Ï†ïÎ≥¥ (ÏÉâ, Ï±Ñ, Î™Ö) - Ìó§Ïñ¥, ÏÑ±Ìòï, ÌîºÎ∂ÄÎäî Ï†úÏô∏ -->
                                            <div
                                                v-if="
                                                    item.color_hue !== null &&
                                                    ![
                                                        'Ìó§Ïñ¥',
                                                        'ÏÑ±Ìòï',
                                                        'ÌîºÎ∂Ä',
                                                    ].includes(item.item_type)
                                                "
                                                class="color-info"
                                            >
                                                <span
                                                    class="color-label"
                                                ></span>
                                                Í≥ÑÏó¥: {{ item.color_range }}
                                                <br />
                                                ÏÉâ: {{ item.color_hue }}, Ï±Ñ:
                                                {{ item.color_saturation }}, Î™Ö:
                                                {{ item.color_value }}
                                            </div>

                                            <!-- ‚úÖ ÎØπÏä§ Ïª¨Îü¨ Ï†ïÎ≥¥ -->
                                            <div
                                                v-if="item.mix_color"
                                                class="mix-color-info"
                                            >
                                                {{ item.base_color }}
                                                {{ 100 - item.mix_rate }}%
                                                {{ item.mix_color }}
                                                {{ item.mix_rate }}%
                                            </div>
                                        </div>
                                    </v-card-text>
                                </v-card>
                            </v-col>
                        </v-row>
                    </v-container>

                    <!-- Î°úÎî© ÏÉÅÌÉú ÌëúÏãú -->
                    <v-progress-circular
                        v-if="loading"
                        indeterminate
                        color="primary"
                    ></v-progress-circular>
                </v-card-text>
            </v-card>
        </v-card>
    </v-dialog>
</template>

<script>
import hairIcon from "@/assets/hair.png";
import faceIcon from "@/assets/face.png";
import skinIcon from "@/assets/skin.png";
import axios from "axios";

export default {
    props: {
        modelValue: {
            type: Boolean,
            required: true,
        },
        character: {
            type: Object,
            required: true,
        },
    },
    emits: ["update:modelValue"],
    data() {
        return {
            characterInfo: {
                image: "",
                name: "",
                items: [],
                personalColor: "",
                mainColor: "",
                subColor: "",
            },
            loading: false,
        };
    },
    computed: {
        visible: {
            get() {
                return this.modelValue;
            },
            set(value) {
                this.$emit("update:modelValue", value);
            },
        },
        personalColorGroup() {
            const colorMap = {
                "Î¥ÑÏõú Î∏åÎùºÏù¥Ìä∏": "Spring",
                "Î¥ÑÏõú Ìä∏Î£®": "Spring",
                "Î¥ÑÏõú ÎùºÏù¥Ìä∏": "Spring",

                "Ïó¨Î¶ÑÏø® ÎùºÏù¥Ìä∏": "Summer",
                "Ïó¨Î¶ÑÏø® Î∏åÎùºÏù¥Ìä∏": "Summer",
                "Ïó¨Î¶ÑÏø® ÎÆ§Ìä∏": "Summer",

                "Í∞ÄÏùÑÏõú ÎÆ§Ìä∏": "Autumn",
                "Í∞ÄÏùÑÏõú Ïä§Ìä∏Î°±": "Autumn",
                "Í∞ÄÏùÑÏõú Îî•": "Autumn",

                "Í≤®Ïö∏Ïø® Î∏åÎùºÏù¥Ìä∏": "Winter",
                "Í≤®Ïö∏Ïø® Ïä§Ìä∏Î°±": "Winter",
                "Í≤®Ïö∏Ïø® Îã§ÌÅ¨": "Winter",
            };

            return colorMap[this.characterInfo.personalColor] || "default";
        },
    },
    watch: {
        visible(newVal) {
            if (newVal) {
                this.loadcharacterInfo();
            }
        },
        character: {
            handler(newCharacter) {
                if (newCharacter.image) {
                    this.characterInfo.image = newCharacter.image;
                    this.loadcharacterInfo();
                }
            },
            deep: true,
            immediate: true,
        },
    },
    methods: {
        async loadcharacterInfo() {
            if (!this.characterInfo.image) {
                console.warn("‚ùó Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.");
                return;
            }

            this.loading = true;
            try {
                const response = await axios.get(
                    `http://localhost:8081/api/personal/popupInfo`,
                    {
                        params: { imageUrl: this.characterInfo.image },
                    }
                );

                const itemData = response.data || {};

                // ‚úÖ Ï≤´ Î≤àÏß∏ ÏïÑÏù¥ÌÖú Í∞ÄÏ†∏Ïò§Í∏∞
                const firstAvailableItem =
                    itemData.searchedCashItemDTOS?.[0] ||
                    itemData.searchedCashFaceDTOS?.[0] ||
                    {};

                // ‚úÖ main_colorÏôÄ sub_colorÎ•º Î∞∞Ïó¥Î°ú Î≥ÄÌôò
                this.characterInfo.personalColor =
                    firstAvailableItem.personal_color
                        ? firstAvailableItem.personal_color
                        : [];
                this.characterInfo.mainColors = firstAvailableItem.main_color
                    ? firstAvailableItem.main_color.split(",")
                    : [];
                this.characterInfo.subColors = firstAvailableItem.sub_color
                    ? firstAvailableItem.sub_color.split(",")
                    : [];

                // ‚úÖ ÏïÑÏù¥ÌÖú Î∞∞Ïó¥ Ï≤òÎ¶¨
                const searchedCashItemDTOS =
                    itemData.searchedCashItemDTOS || [];
                const searchedCashFaceDTOS =
                    itemData.searchedCashFaceDTOS || [];
                let items = [...searchedCashItemDTOS, ...searchedCashFaceDTOS];

                // ‚úÖ ÏïÑÏù¥ÌÖú Í∏∞Î≥∏ ÏïÑÏù¥ÏΩò ÏÑ§Ï†ï
                items = items.map((item) => {
                    let icon =
                        item.item_icon || "https://via.placeholder.com/50";
                    if (item.item_type === "Ìó§Ïñ¥") icon = hairIcon;
                    if (item.item_type === "ÏÑ±Ìòï") icon = faceIcon;
                    if (item.item_type === "ÌîºÎ∂Ä") icon = skinIcon;

                    return { ...item, item_icon: icon };
                });

                // ‚úÖ Ï†ïÎ†¨ ÌõÑ Ï†ÄÏû•
                const priorityTypes = ["Ìó§Ïñ¥", "ÏÑ±Ìòï", "ÌîºÎ∂Ä"];
                const priorityItems = items.filter((item) =>
                    priorityTypes.includes(item.item_type)
                );
                const otherItems = items.filter(
                    (item) => !priorityTypes.includes(item.item_type)
                );
                this.characterInfo.items = [...priorityItems, ...otherItems];
            } catch (error) {
                console.error(
                    "‚ùå Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•ò Î∞úÏÉù:",
                    error
                );
            } finally {
                this.loading = false;
            }
        },

        closeDialog() {
            this.$emit("update:modelValue", false);
        },
    },
};
</script>

<style scoped>
.v-dialog .v-card-text {
    padding: 0 !important;
}
.popup-card {
    padding: 16px;
    border-radius: 12px;
    transition: background-color 0.3s ease;
}

/* Í≥ÑÏ†àÎ≥Ñ ÌåùÏóÖ ÌÖåÎëêÎ¶¨ Î∞∞Í≤ΩÏÉâ */
.popup-card.Spring {
    background-color: #ffe5fb; /* Ïó∞Ìïú Î¥ÑÏõú */
}

.popup-card.Summer {
    background-color: #f0f9ff; /* Ïó∞Ìïú Ïó¨Î¶ÑÏø® */
}

.popup-card.Autumn {
    background-color: #fff5e0; /* Ïó∞Ìïú Í∞ÄÏùÑÏõú */
}

.popup-card.Winter {
    background-color: #e6e6e6; /* Ïó∞Ìïú Í≤®Ïö∏Ïø® */
}

.center-title {
    margin-left: 110px;
    font-size: 1.1rem;
    font-weight: bold;
}
/* Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ Ïä§ÌÉÄÏùº */
.character-img-container {
    display: flex;
    justify-content: center;
    align-items: center;
}

.character-popup {
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* ÌçºÏä§ÎÑêÏª¨Îü¨ ÏòÅÏó≠ */
.color-container {
    padding: 10px;
}

/* Í∏∞Ï°¥ ÌçºÏä§ÎÑêÏª¨Îü¨ Ïä§ÌÉÄÏùº */
.personal-color-result {
    font-size: 13px;
    font-weight: bold;
    text-align: center;
    padding: 8px;
    margin-bottom: 8px;
    width: 249px;
    margin-left: 0.02cm;
}

.personal-color-result.Spring {
    background-color: #fbe7c6;
    color: #8d5524;
}

.personal-color-result.Summer {
    background-color: #e6f7ff;
    color: #007acc;
}

.personal-color-result.Autumn {
    background-color: #fdecc8;
    color: #a64b2a;
}

.personal-color-result.Winter {
    background-color: #f0f4f7;
    color: #3a4e80;
}

/* Î©îÏù∏, ÏÑúÎ∏åÏª¨Îü¨ ÏòÅÏó≠ */
.color-box {
    width: 249px;
    margin-left: 1px;
    margin-bottom: 8px;
    background-color: #f9f9f9; /* Í∏∞Î≥∏ Ïó∞Ìïú Î∞∞Í≤Ω */
}

.color-box.Spring {
    background-color: #fdf3e9; /* Ïó∞Ìïú Î¥ÑÏõú */
}

.color-box.Summer {
    background-color: #f3fbff; /* Ïó∞Ìïú Ïó¨Î¶ÑÏø® */
}

.color-box.Autumn {
    background-color: #fff3e5; /* Ïó∞Ìïú Í∞ÄÏùÑÏõú */
}

.color-box.Winter {
    background-color: #faf5fa; /* Ïó∞Ìïú Í≤®Ïö∏Ïø® */
}

/* Ïª¨Îü¨ ÎùºÎ≤® Ïä§ÌÉÄÏùº */
.color-label {
    font-size: 11px;
    font-weight: bold;
    color: #636364;
    margin-bottom: 6px;
}

/* Ï†úÎ™© ÌÖçÏä§Ìä∏ Ïä§ÌÉÄÏùº */
.color-label {
    font-size: 11px;
    font-weight: bold;
    color: #636364;
    padding-top: 8px;
}

.color-label {
    font-size: 11px;
    font-weight: bold;
    color: #636364;
    padding-top: 8px;
}

/* Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ */
.character-img {
    max-width: 160px;
    height: 160px;
    border-radius: 8px;
    margin-bottom: 15px;
}

/* ÏïÑÏù¥ÌÖú Ï†úÎ™© */
.item-title {
    text-align: center;
    font-weight: bold;
    margin-bottom: 10px;
}

/* Í∞úÎ≥Ñ ÏïÑÏù¥ÌÖú Ïπ¥Îìú */
.item-card {
    padding-left: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
    text-align: left;
    height: 80px;
}

/* Ïπ¥Îìú ÎÇ¥Î∂Ä Ï†ïÎ†¨ */
.item-content {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    justify-content: flex-start;
}

/* ÏïÑÏù¥ÌÖú ÏïÑÏù¥ÏΩò */
.item-icon {
    width: 35px;
    height: 35px;
    flex-shrink: 0;
    background-color: #f0f0f0;
    border-radius: 8px;
    padding: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* ÏïÑÏù¥ÌÖú Ï†ïÎ≥¥ */
.item-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

/* ÏïÑÏù¥ÌÖú Ïù¥Î¶Ñ */
.item-name {
    font-size: 11px;
    font-weight: bold;
    white-space: nowrap;

    text-overflow: ellipsis;
    max-width: 120px;
}

/* ÏïÑÏù¥ÌÖú ÌÉÄÏûÖ */
.item-type {
    font-size: 0.75rem;
    color: gray;
    white-space: nowrap;
}

/* ÏÉâÏÉÅ Ï†ïÎ≥¥ */
.color-info {
    font-size: 0.7rem;
    color: #4c4c4c;
    margin-top: 2px;
    white-space: nowrap;
}

/* ÎØπÏä§ Ïª¨Îü¨ Ï†ïÎ≥¥ */
.mix-color-info {
    font-size: 0.7rem;
    color: #4c4c4c;
    margin-top: 2px;
    white-space: nowrap;
}

/* Îã´Í∏∞ Î≤ÑÌäº */
.close-button {
    display: flex;
    justify-content: flex-end;
    padding-top: 10px;
}
</style>
