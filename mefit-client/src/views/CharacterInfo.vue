<template>
  <v-container class="main-container" fluid>
    <!-- Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ -->
    <div v-if="!characterInfo.character_name">
      <h2>ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</h2>
      <div class="search-bar">
        <button class="search-icon" @click="searchAndSaveCharacter">üîé</button>
        <input
          type="text"
          placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
          :value="characterName"
          @input="updateCharacterName"
          @keydown.enter.prevent="searchAndSaveCharacter"
        />
      </div>
    </div>

    <!-- Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏùÑ Í≤ΩÏö∞ -->
    <div v-else>
      <!-- Í≤ÄÏÉâÏ∞Ω -->
      <v-row dense class="search-bar-row">
        <v-col cols="12" md="12">
          <div class="search-bar-container">
            <input
              type="text"
              placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              :value="characterName"
              class="search-input"
              @input="updateCharacterName"
              @keydown.enter.prevent="searchAndSaveCharacter"
            />

            <button @click="searchAndSaveCharacter" class="search-button">üîç Í≤ÄÏÉâ</button>
          </div>
        </v-col>
      </v-row>
      <!-- ÏÉÅÏúÑ ÏòÅÏó≠ -->
      <v-row class="upper-side" dense>
        <!-- 1Î≤à Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏòÅÏó≠ -->
        <v-col cols="12" md="3">
          <div class="modern-card">
            <h3 class="font-weight-bold">Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥</h3>
            <table class="character-info-table">
              <tbody>
                <!-- Î†àÎ≤® -->
                <tr>
                  <td class="icon-cell">
                    <v-avatar class="level-icon" color="#808080" size="24">
                      <span class="level-text">Lv</span>
                    </v-avatar>
                  </td>
                  <td class="data-cell">
                    <span class="badge">
                      {{
                      characterInfo.character_level ||
                      "Î†àÎ≤®"
                      }}
                    </span>
                  </td>
                </tr>
                <!-- ÏõîÎìú -->
                <tr>
                  <td class="icon-cell">
                    <img
                      v-if="characterInfo.world_name"
                      :src="getWorldIcon(
                                            characterInfo.world_name
                                        )
                                            "
                      alt="world-icon"
                      class="world-icon"
                    />
                  </td>
                  <td class="data-cell">
                    <span class="badge">
                      {{
                      characterInfo.world_name ||
                      "ÏõîÎìúÎ™Ö"
                      }}
                    </span>
                  </td>
                </tr>
                <!-- ÏÑ±Î≥Ñ -->
                <tr>
                  <td class="icon-cell">
                    <v-avatar
                      :color="characterInfo.character_gender ===
                                            'Ïó¨'
                                            ? '#FFC0CB'
                                            : '#87CEEB'
                                            "
                      size="24"
                      class="gender-icon"
                    >
                      <v-icon small color="white">
                        {{
                        characterInfo.character_gender ===
                        "Ïó¨"
                        ? "mdi-gender-female"
                        : "mdi-gender-male"
                        }}
                      </v-icon>
                    </v-avatar>
                  </td>
                  <td class="data-cell">
                    <span class="badge">
                      {{
                      characterInfo.character_gender ||
                      "ÏÑ±Î≥Ñ"
                      }}
                    </span>
                  </td>
                </tr>

                <!-- Í∏∏Îìú -->
                <tr>
                  <td class="icon-cell">
                    <v-avatar class="guild-icon" color="#87CEEB" size="24">
                      <span class="guild-text">G</span>
                    </v-avatar>
                  </td>
                  <td class="data-cell">
                    <span class="badge">
                      {{
                      characterInfo.character_guild_name ||
                      "Í∏∏ÎìúÎ™Ö"
                      }}
                    </span>
                  </td>
                </tr>
                <!-- ÏßÅÏóÖ -->
                <tr>
                  <td class="icon-cell">
                    <img
                      :src="getJobIcon(
                                            characterInfo.character_class
                                        )
                                            "
                      alt="job-icon"
                      class="job-icon"
                    />
                  </td>
                  <td class="data-cell">
                    <span class="badge">
                      {{
                      characterInfo.character_class ||
                      "ÏßÅÏóÖ"
                      }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </v-col>

        <!-- 2Î≤à : Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ ÏòÅÏó≠ -->
        <v-col cols="12" md="4">
          <div class="character-container">
            <!-- ÎèôÏûë(action)Í≥º Í∞êÏ†ï(emotion) ÏÑ†ÌÉù ÏÖÄÎ†âÌä∏ Î∞ïÏä§ -->
            <!-- ÎèôÏûë ÏÑ†ÌÉù ÏÖÄÎ†âÌä∏ Î∞ïÏä§ -->
            <v-select
              label="ÎèôÏûë ÏÑ†ÌÉù"
              :items="actionOptions"
              item-title="codeKorean"
              item-value="code"
              v-model="selectedAction"
              dense
              outlined
              @change="updateCharacterImage"
            />

            <!-- Í∞êÏ†ï ÏÑ†ÌÉù ÏÖÄÎ†âÌä∏ Î∞ïÏä§ -->
            <v-select
              label="Í∞êÏ†ï ÏÑ†ÌÉù"
              :items="emotionOptions"
              item-title="codeKorean"
              item-value="code"
              v-model="selectedEmotion"
              dense
              outlined
              @change="updateCharacterImage"
            />

            <!-- Î¨¥Í∏∞Ï†úÏô∏ Î≤ÑÌäº -->
            <v-btn @click="applyWeaponMotion" color="primary" outlined>Î¨¥Í∏∞Ï†úÏô∏</v-btn>

            <!-- Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ -->
            <v-img
              :src="characterInfo.character_image ||
                            'https://via.placeholder.com/150'
                            "
              alt="Character Image"
              class="character-image"
              :style="{
                                transform: `scale(${scale})`,
                                transition: 'transform 0.3s ease-in-out',
                                'margin-bottom': '40px',
                            }"
            ></v-img>
            <!-- Î≤ÑÌäº Í∑∏Î£π -->
            <div class="button-group">
              <!-- ÌôïÎåÄ/Ï∂ïÏÜå Î≤ÑÌäº -->
              <v-btn
                @click="toggleZoom"
                class="modern-btn"
                elevation="2"
                style="width: 40px; padding: 0; min-width: 40px"
              >
                <v-icon size="20">
                  {{
                  scale === 0.7
                  ? "mdi-magnify-plus-outline"
                  : "mdi-magnify-minus-outline"
                  }}
                </v-icon>
              </v-btn>
              <!-- Îã§Ïö¥Î°úÎìú Î≤ÑÌäº -->
              <v-btn
                @click="downloadImage"
                class="modern-btn"
                elevation="2"
                style="width: 40px; padding: 0; min-width: 40px"
              >
                <v-icon size="20">mdi-download</v-icon>
              </v-btn>
            </div>
          </div>
        </v-col>

        <!-- 3Î≤à: ÌçºÏä§ÎÑê Ïª¨Îü¨ ÏòÅÏó≠ -->
        <v-col cols="12" md="5">
          <div class="modern-card">
            <h3 class="font-weight-bold">ÌçºÏä§ÎÑêÏª¨Îü¨</h3>
            <!-- ÌçºÏä§ÎÑê Ïª¨Îü¨ Î∂ÑÏÑù Í≤∞Í≥º -->
            <div
              :class="[
                            'text-center',
                            'personal-color-result',
                            personalColorGroup,
                        ]"
              @click="navigateToPersonalColorPage"
              style="cursor: pointer"
            >{{ personalColorAnalysis }}</div>

            <!-- Î©îÏù∏ Ïª¨Îü¨ ÌëúÏãú -->
            <v-row class="main-color mb-0 pb-0">
              <v-col cols="3" class="text-left">
                <h4 class="text-left color-label">Î©îÏù∏Ïª¨Îü¨</h4>
              </v-col>
              <v-col cols="9" class="d-flex">
                <v-avatar
                  v-for="(
                                        color, index
                                    ) in characterInfo.main_colors || [
                                                '#ccc',
                                                '#ddd',
                                            ]"
                  :key="'main-color-' + index"
                  :color="color"
                  size="33"
                  class="mr-2"
                ></v-avatar>
              </v-col>
            </v-row>

            <!-- ÏÑúÎ∏åÏª¨Îü¨ ÌëúÏãú -->
            <v-row class="sub-color mt-0 pt-0">
              <v-col cols="3" class="text-left">
                <h4 class="text-left color-label">ÏÑúÎ∏åÏª¨Îü¨</h4>
              </v-col>
              <v-col cols="9" class="d-flex">
                <v-avatar
                  v-for="(
                                        color, index
                                    ) in characterInfo.sub_colors || [
                                                '#eee',
                                                '#fff',
                                            ]"
                  :key="'sub-color-' + index"
                  :color="color"
                  size="33"
                  class="mr-2"
                ></v-avatar>
              </v-col>
            </v-row>
          </div>
        </v-col>
      </v-row>
    </div>
    <!-- 4Î≤à : Ï∫êÏãú Ïû•ÎπÑ Ï†ïÎ≥¥ ÏòÅÏó≠ -->
    <v-row class="mt-4" dense>
      <v-col
        v-for="item in filteredItems"
        :key="item.type"
        cols="12"
        sm="6"
        md="4"
        class="equipment-item"
      >
        <!-- Ï§ëÏïô Ï†ïÎ†¨ÏùÑ ÏúÑÌïú flex Ïª®ÌÖåÏù¥ÎÑà -->
        <div class="equipment-content">
          <!-- ÏïÑÏù¥ÏΩò -->
          <div class="equipment-icon-container">
            <img :src="item.icon" :alt="item.type" class="equipment-icon" />
          </div>
          <!-- Ï∫êÏãú Ïû•ÎπÑ Ï†ïÎ≥¥ -->
          <div class="equipment-details">
            <span class="equipment-name">{{ item.name }}</span>
            <br />
            <span class="equipment-type">{{ item.type }}</span>
            <p class="equipment-subdetails" v-if="item.colorRange">
              Í≥ÑÏó¥: {{ item.colorRange }}
              <br />
              ÏÉâ: {{ item.colorHue }} Ï±Ñ:
              {{ item.colorSaturation }} Î™Ö: {{ item.colorValue }}
            </p>
            <p class="equipment-subdetails" v-else-if="item.mixColor">
              {{ item.baseColor }} : {{ item.baseColorRate }}
              <br />
              {{ item.mixColor }} : {{ item.mixColorRate }}
            </p>
            <p class="equipment-subdetails" v-else-if="item.colorStyle">
              Í≥ÑÏó¥: {{ item.colorStyle }}
              <br />
              ÏÉâ: {{ item.skinHue }} Ï±Ñ:
              {{ item.skinSaturation }} Î™Ö:
              {{ item.skinBrightness }}
            </p>
          </div>
        </div>
      </v-col>
    </v-row>
    <!-- Í≥µÌÜµ ÏïåÎ¶º ÌåùÏóÖ Ï∂îÍ∞Ä -->
    <CustomAlert
      v-if="showAlert"
      :visible="showAlert"
      title="ÏïåÎ¶º"
      message="Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Ï∫êÎ¶≠ÌÑ∞ÏûÖÎãàÎã§."
      @close="showAlert = false"
    />
  </v-container>
</template>

<script>
import axios from "axios";
import CustomAlert from "@/components/CustomAlert.vue"; // Í≥µÌÜµ ÏïåÎ¶º Ïª¥Ìè¨ÎÑåÌä∏

export default {
  name: "CharacterInfo",
  components: { CustomAlert },
  data() {
    return {
      scale: 0.7, // Ï¥àÍ∏∞ ÌôïÎåÄ Î∞∞Ïú®
      characterName: "", // Í≤ÄÏÉâÏñ¥
      characterInfo: {}, // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Îç∞Ïù¥ÌÑ∞
      showAlert: false, // ÏïåÎ¶º ÌåùÏóÖ ÏÉÅÌÉú Ï∂îÍ∞Ä
      message: "", // Ïò§Î•ò Î©îÏãúÏßÄ
      characterCashItem: [],
      characterCashFace: [],
      personalColorAnalysis: "",
      REQUIRED_ITEM_TYPES: [
        { type: "Ìó§Ïñ¥", icon: require("@/assets/hair.png"), name: "" },
        { type: "ÏÑ±Ìòï", icon: require("@/assets/face.png"), name: "" },
        { type: "ÌîºÎ∂Ä", icon: require("@/assets/skin.png"), name: "" },
        { type: "Î™®Ïûê", icon: "", name: "" },
        { type: "ÏñºÏû•", icon: "", name: "" },
        { type: "ÎààÏû•", icon: "", name: "" },
        { type: "Í∑ÄÍ±∏", icon: "", name: "" },
        { type: "ÏÉÅÏùò", icon: "", name: "" },
        { type: "ÌïòÏùò", icon: "", name: "" },
        { type: "Ïã†Î∞ú", icon: "", name: "" },
        { type: "Ïû•Í∞ë", icon: "", name: "" },
        { type: "ÎßùÌÜ†", icon: "", name: "" },
        { type: "Î¨¥Í∏∞", icon: "", name: "" }
      ],
      actionOptions: [], // Ï¥àÍ∏∞ Îπà Î∞∞Ïó¥
      emotionOptions: [], // Ï¥àÍ∏∞ Îπà Î∞∞Ïó¥
      selectedAction: null,
      selectedEmotion: null
    };
  },
  methods: {
    // ÏõîÎìúÎ™Ö Îß§Ìïë Í∞ùÏ≤¥
    getWorldIcon(worldName) {
      const worldNameMap = {
        ÏïÑÏºÄÏù∏: "arcane",
        Ïò§Î°úÎùº: "aurora",
        Î≤†Îùº: "bera",
        ÌÅ¨Î°úÏïÑ: "croa",
        ÏóòÎ¶¨ÏãúÏõÄ: "elysium",
        Ïù¥ÎÖ∏ÏãúÏä§: "enosis",
        ÏóêÏò§Ïä§: "eos",
        Ìó¨Î¶¨Ïò§Ïä§: "helios",
        Î£®ÎÇò: "luna",
        ÎÖ∏Î∞î: "nova",
        Î†àÎìú: "red",
        Ïä§Ïπ¥ÎãàÏïÑ: "scania",
        Ïú†ÎãàÏò®: "union",
        Ï†úÎãàÏä§: "zenith"
      };
      const fileName = worldNameMap[worldName] || "default";
      return require(`@/assets/world/${fileName}.png`);
    },
    /**
     * Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄÎ•º ÌôïÎåÄ/Ï∂ïÏÜåÌïòÎäî Î©îÏÑúÎìú
     */
    /**
     * ÌôïÎåÄ/Ï∂ïÏÜå ÌÜ†Í∏Ä
     */
    toggleZoom() {
      this.scale = this.scale === 1.0 ? 0.7 : 1.0;
    },
    async downloadImage() {
      try {
        const response = await fetch(this.characterInfo.character_image);
        const blob = await response.blob();
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "character_image.png"; // Îã§Ïö¥Î°úÎìú ÌååÏùº Ïù¥Î¶Ñ
        link.click();
        URL.revokeObjectURL(link.href); // Î©îÎ™®Î¶¨ Ìï¥Ï†ú
      } catch (error) {
        console.error("Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:", error);
      }
    },
    updateCharacterName(event) {
      this.characterName = event.target.value; // ÏûÖÎ†•Í∞í Î™ÖÏãúÏ†Å ÎèôÍ∏∞Ìôî
    },
    /**
     * Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º APIÏóêÏÑú Í≤ÄÏÉâ Î∞è Ï†ÄÏû•
     */
    async searchAndSaveCharacter() {
      if (!this.characterName) return; // Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶ÑÏù¥ ÏóÜÏúºÎ©¥ Ï§ëÎã®
      try {
        const ocidResponse = await axios.get(
          `http://localhost:8081/api/characters/ocid`,
          {
            params: {
              name: this.characterName,
              personalColor: this.personalColorAnalysis
            }
          }
        );
        this.characterInfo = ocidResponse.data.characterInfoDTO;
        this.message = "";

        this.characterCashItem = ocidResponse.data.searchedCashItemDTOS;
        this.characterCashFace = ocidResponse.data.searchedCashFaceDTOS;

        this.loadMotionData(); // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎèôÏûë/Í∞êÏ†ï Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        // Ïù¥ÎØ∏ÏßÄÍ∞Ä Î°úÎìúÎêú ÌõÑ extractColors Ïã§Ìñâ
        const img = new Image();
        img.crossOrigin = "Anonymous"; // ÌÅ¨Î°úÏä§ ÎèÑÎ©îÏù∏ Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨
        img.src = this.characterInfo.character_image;

        img.onload = async () => {
          await this.extractColors(img); // ‚úÖ ÌçºÏä§ÎÑêÏª¨Îü¨ Î∂ÑÏÑùÏùÑ Í∏∞Îã§Î¶∞ ÌõÑ Ïã§Ìñâ
          this.savePersonalColor(); // ‚úÖ ÌçºÏä§ÎÑêÏª¨Îü¨ Î∂ÑÏÑùÏù¥ ÎÅùÎÇú ÌõÑ Ï†ÄÏû•
        };

        this.message = "";
      } catch (error) {
        console.error("Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:", error);
        this.showAlert = true; // Ïò§Î•ò Î∞úÏÉù Ïãú ÏïåÎ¶º ÌåùÏóÖ ÌëúÏãú
        this.message = "Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
      }
    },
    /**
     * Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ URLÏùÑ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî Î©îÏÑúÎìú
     */
    updateCharacterImage() {
      const baseImageUrl = this.characterInfo.character_image.split("?")[0]; // Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ URL
      const params = new URLSearchParams();

      // ÏÑ†ÌÉùÎêú ÎèôÏûë(action)Í≥º Í∞êÏ†ï(emotion)ÏùÑ URL ÌååÎùºÎØ∏ÌÑ∞Î°ú Ï∂îÍ∞Ä
      if (this.selectedAction) params.append("action", this.selectedAction);
      if (this.selectedEmotion) params.append("emotion", this.selectedEmotion);

      // Î¨¥Í∏∞Ï†úÏô∏(wmotion) ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä
      if (this.selectedWeaponMotion) params.append("wmotion", "W04");

      // ÏÉàÎ°úÏö¥ Ïù¥ÎØ∏ÏßÄ URL ÏÉùÏÑ±
      this.characterImage = `${baseImageUrl}?${params.toString()}`;

      console.log("Updated Image URL:", this.characterImage); // ÏΩòÏÜîÏóêÏÑú ÌôïÏù∏
    },

    /**
     * ÎèôÏûë Î∞è Í∞êÏ†ï ÌëúÌòÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
     */
    async loadMotionData() {
      try {
        const response = await axios.get(
          `http://localhost:8081/api/characters/motions`
        );
        const motions = response.data;

        // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
        console.log("ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:", motions);

        // ÎèôÏûëÍ≥º Í∞êÏ†ï ÏòµÏÖòÏùÑ Î∂ÑÎ¶¨ÌïòÏó¨ ÌïÑÌÑ∞ÎßÅ
        this.actionOptions = motions.filter(m => m.category === "action");
        this.emotionOptions = motions.filter(m => m.category === "emotion");

        // ÌïÑÌÑ∞ÎßÅ ÌõÑ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
        console.log("actionOptions:", this.actionOptions);
        console.log("emotionOptions:", this.emotionOptions);
      } catch (error) {
        console.error("ÎèôÏûë Î∞è Í∞êÏ†ï Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
      }
    },

    /**
     * Î¨¥Í∏∞Ï†úÏô∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú wmotion Ï∂îÍ∞Ä
     */
    applyWeaponMotion() {
      // Î¨¥Í∏∞Ï†úÏô∏Î•º ÏÑ†ÌÉùÌñàÏùÑ Îïå updateCharacterImageÎ•º Ìò∏Ï∂úÌïòÏó¨ wmotion ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä
      this.selectedWeaponMotion = "W04";
      this.updateCharacterImage();
    },

    async savePersonalColor() {
      const personalColor = this.personalColorAnalysis;

      console.log("ÌçºÏä§ÎÑêÏª¨Îü¨:" + personalColor);

      try {
        await axios.post(
          `http://localhost:8081/api/characters/personal-color`,
          new URLSearchParams({
            characterImage: this.characterInfo.character_image,
            personalColor: this.personalColorAnalysis
          }),
          {
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            }
          }
        );
        console.log("ÌçºÏä§ÎÑêÏª¨Îü¨ Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.");
      } catch (error) {
        console.error("ÌçºÏä§ÎÑêÏª¨Îü¨ Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:", error);
      }
    },
    getJobIcon(jobName) {
      try {
        return require(`@/assets/job/${jobName}.png`);
      } catch (e) {
        return null;
      }
    },
    //ÌçºÏä§ÎÑêÏª¨Îü¨ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    navigateToPersonalColorPage() {
      const color = this.personalColorAnalysis;
      const encodedColor = encodeURIComponent(color); // URL Ïù∏ÏΩîÎî©
      this.$router.push(`/personal-color-twelve/${encodedColor}`);
    },
    //ÌçºÏä§ÎÑêÏπºÎùº Î∂ÑÏÑù Î∂ÄÎ∂Ñ
    async extractColors(img) {
      return new Promise(resolve => {
        // ‚úÖ ÎèôÏ†ÅÏúºÎ°ú Canvas ÏÉùÏÑ±
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, img.width, img.height).data;
        const colorCounts = {};

        // ‚úÖ Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞Î•º ÏàúÌöåÌïòÏó¨ ÏÉâÏÉÅ Ï†ïÎ≥¥Î•º ÏàòÏßë
        for (let i = 0; i < imageData.length; i += 4) {
          const r = imageData[i];
          const g = imageData[i + 1];
          const b = imageData[i + 2];
          const a = imageData[i + 3];

          // ‚úÖ Ìà¨Î™ÖÎèÑ Î∞è ÏôÑÏ†Ñ Í≤ÄÏ†ï/Ìù∞ÏÉâ Ï†úÏô∏
          if (
            a === 0 ||
            (r === 0 && g === 0 && b === 0) ||
            (r === 255 && g === 255 && b === 255)
          )
            continue;

          const hsv = this.rgbToHsv(r, g, b);

          // ‚úÖ ÎÑàÎ¨¥ Ïñ¥Îë°Í±∞ÎÇò Î∞ùÏùÄ ÏÉâÏÉÅ, Ï±ÑÎèÑÍ∞Ä ÎÇÆÏùÄ ÏÉâÏÉÅ Ï†úÏô∏
          if (hsv.v < 5 || hsv.v > 90 || hsv.s < 3) continue;

          // **HSV Í∑ºÏ≤ò ÏÉâÏÉÅ ÌÜµÌï©**
          const roundedH = Math.round(hsv.h / 5) * 5;
          const roundedS = Math.round(hsv.s / 5) * 5;
          const roundedV = Math.round(hsv.v / 5) * 5;
          const key = `${roundedH},${roundedS},${roundedV}`;

          colorCounts[key] = (colorCounts[key] || 0) + 1;
        }

        // ‚úÖ ÏÉÅÏúÑ 30Í∞ú ÏÉâÏÉÅ Ï∂îÏ∂ú Î∞è Í∞ÄÏ§ëÏπò Í≥ÑÏÇ∞
        const sortedColors = Object.entries(colorCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 30);

        let hSum = 0,
          sSum = 0,
          vSum = 0,
          totalWeight = 0;
        const weights = sortedColors.map((_, index) =>
          index < 20 ? 0.1 : 0.02
        );

        sortedColors.forEach(([key], index) => {
          const [h, s, v] = key.split(",").map(Number);
          const weight = weights[index];
          hSum += h * weight;
          sSum += s * weight;
          vSum += v * weight;
          totalWeight += weight;
        });

        const avgH = hSum / totalWeight;
        const avgS = sSum / totalWeight;
        const avgV = vSum / totalWeight;

        // ‚úÖ ÏµúÏ¢Ö ÌçºÏä§ÎÑêÏª¨Îü¨ Î∂ÑÏÑù
        this.personalColorAnalysis = this.findClosestPersonalColor(
          avgH,
          avgS,
          avgV
        );

        // ‚úÖ Canvas Ï†úÍ±∞
        canvas.remove();

        resolve();
      });
    },

    rgbToHsv(r, g, b) {
      (r /= 255), (g /= 255), (b /= 255);
      let max = Math.max(r, g, b),
        min = Math.min(r, g, b);
      let h,
        s,
        v = max,
        d = max - min;
      s = max === 0 ? 0 : d / max;
      if (max === min) h = 0;
      else
        h =
          max === r
            ? (g - b) / d + (g < b ? 6 : 0)
            : max === g
            ? (b - r) / d + 2
            : (r - g) / d + 4;
      h /= 6;
      return { h: h * 360, s: s * 100, v: v * 100 };
    },
    findClosestPersonalColor(h, s, v) {
      const personalColors = [
        { tone: "Î¥ÑÏõú Î∏åÎùºÏù¥Ìä∏", h: [0, 30], s: 60, v: 55 }, // Ï±ÑÎèÑ(S) Í∏∞Ï§Ä ÏÉÅÌñ•
        { tone: "Î¥ÑÏõú Ìä∏Î£®", h: [30, 50], s: 50, v: 50 },
        { tone: "Î¥ÑÏõú ÎùºÏù¥Ìä∏", h: [50, 80], s: 40, v: 50 },

        { tone: "Ïó¨Î¶ÑÏø® ÎùºÏù¥Ìä∏", h: [110, 140], s: 30, v: 45 },
        { tone: "Ïó¨Î¶ÑÏø® Î∏åÎùºÏù¥Ìä∏", h: [140, 170], s: 35, v: 45 },
        { tone: "Ïó¨Î¶ÑÏø® ÎÆ§Ìä∏", h: [170, 220], s: 25, v: 40 },

        { tone: "Í∞ÄÏùÑÏõú ÎÆ§Ìä∏", h: [40, 120], s: 20, v: 30 }, // Hue Î≤îÏúÑ ÌôïÏû•
        { tone: "Í∞ÄÏùÑÏõú Ïä§Ìä∏Î°±", h: [80, 170], s: 30, v: 35 },
        { tone: "Í∞ÄÏùÑÏõú Îî•", h: [50, 200], s: 15, v: 20 }, // Hue ÏµúÎåÄ Î≤îÏúÑ ÌôïÏû•

        { tone: "Í≤®Ïö∏Ïø® Î∏åÎùºÏù¥Ìä∏", h: [200, 270], s: 45, v: 55 },
        { tone: "Í≤®Ïö∏Ïø® Ïä§Ìä∏Î°±", h: [180, 280], s: 30, v: 35 },
        { tone: "Í≤®Ïö∏Ïø® Îã§ÌÅ¨", h: [270, 360], s: 50, v: 40 }
      ];

      return personalColors.reduce(
        (closest, color) => {
          const midH = (color.h[0] + color.h[1]) / 2;
          const diff =
            Math.abs(midH - h) + Math.abs(color.s - s) + Math.abs(color.v - v);
          return diff < closest.diff
            ? { tone: color.tone, diff: diff }
            : closest;
        },
        { tone: "Í≤®Ïö∏Ïø® Îã§ÌÅ¨", diff: Infinity }
      ).tone;
    }
  },
  created() {
    // ÎùºÏö∞ÌÑ∞Ïùò ÏøºÎ¶¨ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
    this.characterName = this.$route.query.q || "";
    if (this.characterName) {
      // Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶ÑÏù¥ ÏûàÏùÑ Í≤ΩÏö∞ API Ìò∏Ï∂ú
      this.searchAndSaveCharacter();
    }
  },
  computed: {
    filteredItems() {
      return this.REQUIRED_ITEM_TYPES.map(requiredItemType => {
        const cashItemData = this.characterCashItem.find(
          itemData => itemData.item_type === requiredItemType.type
        );

        const cashFaceData = this.characterCashFace.find(
          itemData => itemData.item_type === requiredItemType.type
        );

        // ÏïÑÏù¥ÌÖú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏÑ∏Î∂Ä Ï†ïÎ≥¥Î•º Ï∂îÍ∞Ä
        if (cashItemData && cashItemData.item_name) {
          return {
            type: requiredItemType.type,
            icon: cashItemData.item_icon || "https://via.placeholder.com/50",
            name: cashItemData.item_name,
            colorRange: cashItemData.color_range || null, // nullÎ°ú Ïú†ÏßÄ
            colorHue: cashItemData.color_hue || 0,
            colorSaturation: cashItemData.color_saturation || 0,
            colorValue: cashItemData.color_value || 0
          };
        }

        if (cashFaceData && cashFaceData.item_name) {
          return {
            type: requiredItemType.type,
            icon: requiredItemType.icon,
            name: cashFaceData.item_name,
            baseColor: cashFaceData.base_color,
            baseColorRate: 100 - cashFaceData.mix_rate + "%",
            mixColor: cashFaceData.mix_color,
            mixColorRate: cashFaceData.mix_rate + "%",
            colorStyle: cashFaceData.color_style || null, // nullÎ°ú Ïú†ÏßÄ
            skinHue: cashFaceData.skin_hue || 0,
            skinSaturation: cashFaceData.skin_saturation || 0,
            skinBrightness: cashFaceData.skin_brightness || 0
          };
        }

        // Í∏∞Î≥∏Í∞í Î∞òÌôò
        if (requiredItemType.name) {
          return {
            type: requiredItemType.type,
            icon: requiredItemType.icon || "https://via.placeholder.com/50",
            name: requiredItemType.name
          };
        }

        return null; // ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏúºÎ©¥ null
      }).filter(item => item !== null);
    },
    //ÌçºÏä§ÎÑêÏª¨Îü¨ Î∞∞Í≤ΩÏÉâ ÏßÄÏ†ï
    personalColorGroup() {
      const colorMap = {
        "Î¥ÑÏõú Î∏åÎùºÏù¥Ìä∏": "Spring",
        "Î¥ÑÏõú Ìä∏Î£®": "Spring",
        "Î¥ÑÏõú ÎùºÏù¥Ìä∏": "Spring",

        "Ïó¨Î¶ÑÏø® ÎùºÏù¥Ìä∏": "Summer",
        "Ïó¨Î¶ÑÏø® Î∏åÎùºÏù¥Ìä∏": "Summer",
        "Ïó¨Î¶ÑÏø® ÎÆ§Ìä∏": "Summer",

        "Í∞ÄÏùÑÏõú ÎÆ§Ìä∏": "Autumn",
        "Í∞ÄÏùÑÏõú Ïä§Ìä∏Î°±": "Autumn",
        "Í∞ÄÏùÑÏõú Îî•": "Autumn",

        "Í≤®Ïö∏Ïø® Î∏åÎùºÏù¥Ìä∏": "Winter",
        "Í≤®Ïö∏Ïø® Ïä§Ìä∏Î°±": "Winter",
        "Í≤®Ïö∏Ïø® Îã§ÌÅ¨": "Winter"
      };

      return colorMap[this.personalColorAnalysis] || "default";
    }
  }
};
</script>

<style scoped>
.main-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 16px;
  /* ÏñëÏ™Ω Ìå®Îî© ÏÑ§Ï†ï */
}

.character-container {
  position: relative;
  height: 230px;
  margin: 0 auto;
  border-radius: 8px;
  background-color: #fff;
  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  /* overflow: hidden; */
  /* ÌûàÎì†Î≤ÑÌäº */
}

.character-image {
  height: 200px;
  /* Ïù¥ÎØ∏ÏßÄ ÏµúÎåÄ ÎÜíÏù¥ */
  width: auto;
  display: block;
  margin: 0 auto;
  /* Ïù¥ÎØ∏ÏßÄ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
}

/*1,2,3, ÏùºÎ†¨Î°ú */
.character-info {
  text-align: left;
  padding-left: 5px;
  margin-top: 20px;
}

.equipment-item {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  /* Í∞ÄÎ°ú Ï†ïÎ†¨ÏùÑ ÏôºÏ™ΩÏúºÎ°ú Í≥†Ï†ï */
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 12px;
  background-color: #ffffff;
  box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
  min-height: 120px;
  /* Ï†ÅÏ†àÌïú ÏµúÏÜå ÎÜíÏù¥ ÏÑ§Ï†ï */
  transition: border 0.3s ease, box-shadow 0.3s ease;
}

.equipment-content {
  display: flex;
  align-items: center;
  /* ÏàòÏßÅ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
  width: 100%;
  /* Í∞ÄÎ°ú Ï†ïÎ†¨ Î¨∏Ï†ú Ìï¥Í≤∞ */
}

.equipment-icon-container {
  display: flex;
  align-items: center;
  justify-content: center;
}

.equipment-icon {
  width: 50px;
  height: 50px;
  object-fit: contain;
  border: 2px solid #f0f0f0;
  border-radius: 8px;
  margin-left: 10px;
  padding: 6px;
  background-color: #f9f9f9;
}

.equipment-item:hover {
  border: 1px solid #ff88aa;
  box-shadow: 0px 4px 10px rgba(255, 136, 170, 0.3);
}

.equipment-details {
  flex-grow: 1;
  text-align: left;
  line-height: 1.5;
  margin-left: 13px;
}

.equipment-name {
  font-weight: bold;
  font-size: 14px;
  margin-bottom: 5px;
}

.equipment-type {
  font-size: 12px;
  color: #335cc4ad;
}

.equipment-subdetails {
  font-size: 12px;
  color: #666;
  line-height: 1.4;
}

.button-row {
  margin-top: 16px;
  /* Î≤ÑÌäºÍ≥º Ïù¥ÎØ∏ÏßÄ Í∞ÑÍ≤© */
  display: flex;
  justify-content: center;
  /* Î≤ÑÌäºÏùÑ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
  gap: 16px;
  /* Î≤ÑÌäº Í∞ÑÍ≤© */
}

.button-row v-btn {
  box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
  /* Î≤ÑÌäº Í∑∏Î¶ºÏûê */
}

.zoom-button-container {
  margin-top: 55px;
  /* Ïù¥ÎØ∏ÏßÄÏôÄ Î≤ÑÌäº ÏÇ¨Ïù¥ Í∞ÑÍ≤©ÏùÑ Îçî ÎÑìÍ≤å */
  text-align: center;
}

.button-group {
  position: absolute;
  bottom: 16px;
  /* Ïª®ÌÖåÏù¥ÎÑà ÌïòÎã®ÏóêÏÑú Ïó¨Î∞± */
  right: 16px;
  /* Ïª®ÌÖåÏù¥ÎÑà Ïò§Î•∏Ï™ΩÏóêÏÑú Ïó¨Î∞± */
  display: flex;
  gap: 8px;
  /* Î≤ÑÌäº Í∞Ñ Í∞ÑÍ≤© */
  z-index: 10;
  /* Ïù¥ÎØ∏ÏßÄ ÏúÑÏóê ÏúÑÏπò */
}

.button-group v-btn {
  width: 40px;
  /* Î≤ÑÌäº ÌÅ¨Í∏∞ */
  height: 40px;
  border-radius: 50%;
  /* ÏõêÌòï Î≤ÑÌäº */
  box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
}

.search-bar {
  display: flex;
  align-items: center;
  border: 2px solid #ffccff;
  border-radius: 20px;
  padding: 8px 12px;
  width: 300px;
  margin: 0 auto;
  box-shadow: 0 0 8px #ffccff;
  transition: box-shadow 0.3s ease;
  background-color: #fff5ff;
}

.search-bar input {
  border: none;
  outline: none;
  font-size: 14px;
  flex: 1;
  background: none;
}

.search-bar input::placeholder {
  color: #ff88aa;
}

.badge {
  display: inline-block;
  padding: 0px 8px;
  /* ÌÖçÏä§Ìä∏ Ï£ºÎ≥Ä Ïó¨Î∞± */
  border: 1px solid #ccc;
  /* ÌÖåÎëêÎ¶¨ ÏÉâÏÉÅ */
  border-radius: 12px;
  /* Îë•Í∑º ÌÖåÎëêÎ¶¨ */
  background-color: #f5f5f5;
  /* Î∞∞Í≤ΩÏÉâ */
  font-size: 0.875rem;
  /* Í∏ÄÏî® ÌÅ¨Í∏∞ */
  font-weight: 500;
  /* Í∏ÄÏî® ÍµµÍ∏∞ */
  color: #333;
  /* ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ */
  margin-right: 8px;
  /* ÏöîÏÜå Í∞Ñ Í∞ÑÍ≤© */
}

.character-info-table {
  margin-top: 10px;
  margin-left: 8px;
  border-spacing: 0 8px;
  /* ÏúÑÏïÑÎûò Í∞≠ Ï∂îÍ∞Ä */
  border-collapse: separate;
  /* ÏÖÄ Í∞ÑÍ≤© Ïú†ÏßÄ */
}

.icon-cell {
  display: flex;
  justify-content: center;
  /* Í∞ÄÎ°ú Ï†ïÎ†¨ */
  align-items: center;
  /* ÏÑ∏Î°ú Ï†ïÎ†¨ */
  height: 100%;
  /* Î∂ÄÎ™® ÎÜíÏù¥Ïóê ÎßûÏ∂§ */
}

.data-cell {
  text-align: left;
  vertical-align: middle;
  padding-left: 13px;
  /* Îç∞Ïù¥ÌÑ∞ ÏÖÄ ÏôºÏ™Ω Ìå®Îî© */
}

.gender-icon,
.guild-icon,
.job-icon {
  width: 20px;
  /* ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ */
  height: 20px;
}

.world-icon {
  width: 27px;
  height: 27px;
}

.level-icon,
.guild-icon,
.job-icon {
  width: 24px;
  height: 24px;
}

.level-text,
.guild-text {
  font-size: 12px;
  font-weight: bold;
  line-height: 1;
  color: white;
}

.gender-icon {
  width: 20px;
  height: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 14px;
  /* ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ */
  font-weight: bold;
  line-height: 1;
}

.world-guild {
  margin-top: 8px;
  /* Î†àÎ≤®/ÏÑ±Î≥ÑÍ≥º Í∞ÑÍ≤© */
}

.job-image {
  width: 80px;
  /* ÏßÅÏóÖ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ */
  height: 80px;
  border-radius: 8px;
  margin-bottom: 8px;
  /* ÏßÅÏóÖ Ïù¥Î¶ÑÍ≥º Í∞ÑÍ≤© */
}

.job-badge {
  font-size: 1rem;
  font-weight: bold;
  color: #333;
  background-color: #f5f5f5;
  padding: 4px 8px;
  border-radius: 12px;
}

/* Í≤ÄÏÉâÏ∞Ω*/
.search-bar-container {
  display: flex;
  justify-content: center;
  /* Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
  align-items: center;
  width: 100%;
  /* Ï†ÑÏ≤¥ Í∏∏Ïù¥ */
  padding: 12px 16px;
  /* Ïó¨Î∞± Ï∂îÍ∞Ä */
  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
  /* Î∂ÄÎìúÎü¨Ïö¥ Í∑∏Î¶ºÏûê */
  background-color: #ffffff;
  /* Î∞∞Í≤ΩÏÉâ */
  border-radius: 8px;
  /* Îë•Í∑º Î™®ÏÑúÎ¶¨ */
  margin-bottom: 16px;
  /* ÏïÑÎûò Ïª®ÌÖêÏ∏†ÏôÄ Í∞ÑÍ≤© */
}

.search-input {
  flex: 1;
  /* Í≤ÄÏÉâÏ∞Ω ÎÑàÎπÑÎ•º Î≤ÑÌäºÍ≥º Ìï®Íªò Ï°∞Ï†ï */
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  outline: none;
  margin-right: 8px;
}

.search-button {
  background-color: #d96dcb;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;

  cursor: pointer;
  transition: background-color 0.3s ease;
}

.search-button:hover {
  background-color: #e58cda;
}

/*ÌçºÏä§ÎÑêÏª¨Îü¨*/
.modern-card {
  height: 230px;
  background-color: #ffffff;
  color: #2c3e50;
  border-radius: 8px;
  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  align-items: center;
}

/*ÌçºÏä§ÎÑêÏª¨Îü¨ Í≤∞Í≥º */
.personal-color-result {
  width: 100%;
  font-size: 16px;
  font-weight: bold;
  text-transform: uppercase;
  padding: 4px 8px;
  /* Ìå®Îî© Ï°∞Ï†ï */
  text-align: center;
  margin-top: 8px;
}

.personal-color-result.Spring {
  background-color: #fbe7c6;
  color: #8d5524;
}

.personal-color-result.Summer {
  background-color: #e6f7ff;
  color: #007acc;
}

.personal-color-result.Autumn {
  background-color: #fdecc8;
  color: #a64b2a;
}

.personal-color-result.Winter {
  background-color: #f0f4f7;
  color: #3a4e80;
}

.main-color {
  margin-top: 10px;
  margin-bottom: 0 !important;
  /* ÌïòÎã® ÎßàÏßÑ Ï†úÍ±∞ */
  padding-bottom: 0 !important;
  /* ÌïòÎã® Ìå®Îî© Ï†úÍ±∞ */
}

.sub-color {
  margin-top: 0 !important;
  /* ÌïòÎã® ÎßàÏßÑ Ï†úÍ±∞ */
  padding-top: 0 !important;
  /* ÌïòÎã® Ìå®Îî© Ï†úÍ±∞ */
}

.color-label {
  background-color: #f5f5f5;
  /* ÌöåÏÉâ Î∞∞Í≤Ω */
  padding: 1px 2px;
  border-radius: 12px;
  font-weight: bold;
  color: #333;
}
</style>
